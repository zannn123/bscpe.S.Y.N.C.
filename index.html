<html class="scroll-smooth" lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   CPE S.Y.N.C. - Synchronized Yield and Notification Console
  </title>
  <script src="https://cdn.tailwindcss.com">
  </script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&amp;display=swap" rel="stylesheet"/>
  <style>
   body {
      font-family: 'Inter', sans-serif;
    }
  </style>
 </head>
 <body class="bg-gray-50 min-h-screen flex flex-col">
  <div class="flex-grow flex flex-col max-w-5xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-6" id="app">
   <!-- Header -->
   <header class="flex items-center justify-between py-4 border-b border-gray-300">
    <h1 class="text-3xl font-extrabold text-indigo-700 select-none">
     JRMSU CpE S.Y.N.C.
    </h1>
    <nav class="space-x-4 text-indigo-700 font-medium">
     <button class="hover:underline focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded" id="nav-home">
      Home
     </button>
     <button class="hover:underline focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded" id="nav-login">
      Login
     </button>
     <button class="hover:underline focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded" id="nav-register">
      Register
     </button>
     <button class="hidden hover:underline focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded" id="nav-logout">
      Logout
     </button>
    </nav>
   </header>
   <!-- Announcement Banner -->
   <section class="hidden bg-indigo-100 border border-indigo-300 rounded-md p-4 my-4 text-indigo-900 font-semibold" id="announcement-banner">
   </section>
   <!-- Main Content -->
   <main class="flex-grow mt-4" id="main-content">
    <!-- Home Page -->
    <section class="space-y-6" id="page-home">
     <h2 class="text-xl font-semibold text-gray-800">
      Upcoming &amp; Current Events
     </h2>
     <div class="space-y-6" id="events-list">
     </div>
    </section>
    <!-- Login Page -->
    <section class="hidden max-w-md mx-auto bg-white p-6 rounded-md shadow-md" id="page-login">
     <h2 class="text-2xl font-semibold mb-4 text-indigo-700">
      Login
     </h2>
     <form autocomplete="off" class="space-y-4" id="login-form" novalidate="">
      <div>
       <label class="block text-gray-700 font-medium mb-1" for="login-username">
        Username
       </label>
       <input class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" id="login-username" name="username" required="" type="text"/>
      </div>
      <div>
       <label class="block text-gray-700 font-medium mb-1" for="login-password">
        Password
       </label>
       <input class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" id="login-password" name="password" required="" type="password"/>
      </div>
      <div>
       <label class="block text-gray-700 font-medium mb-1" for="login-hostcode">
        Host Login Code (optional)
       </label>
       <input class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" id="login-hostcode" name="hostcode" placeholder="Enter host code if you are a host" type="text"/>
      </div>
      <button class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" type="submit">
       Login
      </button>
     </form>
     <p class="mt-4 text-center text-gray-600">
      Don't have an account?
      <button class="text-indigo-600 hover:underline focus:outline-none" id="go-register">
       Register here
      </button>
     </p>
     <p class="mt-2 text-red-600 font-semibold hidden" id="login-error">
     </p>
    </section>
    <!-- Register Page -->
    <section class="hidden max-w-md mx-auto bg-white p-6 rounded-md shadow-md" id="page-register">
     <h2 class="text-2xl font-semibold mb-4 text-indigo-700">
      Register
     </h2>
     <form autocomplete="off" class="space-y-4" id="register-form" novalidate="">
      <div>
       <label class="block text-gray-700 font-medium mb-1" for="register-username">
        Username
       </label>
       <input class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" id="register-username" name="username" required="" type="text"/>
      </div>
      <div>
       <label class="block text-gray-700 font-medium mb-1" for="register-password">
        Password
       </label>
       <input class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" id="register-password" name="password" required="" type="password"/>
      </div>
      <div>
       <label class="block text-gray-700 font-medium mb-1" for="register-hostcode">
        Host Registration Code (optional)
       </label>
       <input class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" id="register-hostcode" name="hostcode" placeholder="Enter host code if registering as host" type="text"/>
      </div>
      <button class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" type="submit">
       Register
      </button>
     </form>
     <p class="mt-4 text-center text-gray-600">
      Already have an account?
      <button class="text-indigo-600 hover:underline focus:outline-none" id="go-login">
       Login here
      </button>
     </p>
     <p class="mt-2 text-red-600 font-semibold hidden" id="register-error">
     </p>
    </section>
    <!-- Event Check-in Modal -->
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50" id="checkin-modal">
     <div class="bg-white rounded-md max-w-md w-full p-6 relative shadow-lg">
      <button aria-label="Close modal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 focus:outline-none" id="checkin-close">
       <i class="fas fa-times fa-lg">
       </i>
      </button>
      <h3 class="text-xl font-semibold text-indigo-700 mb-4" id="checkin-event-title">
      </h3>
      <form autocomplete="off" class="space-y-4" id="checkin-form" novalidate="">
       <div>
        <label class="block text-gray-700 font-medium mb-1" for="checkin-code">
         Enter Attendance Code
        </label>
        <input class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" id="checkin-code" name="code" required="" type="text"/>
       </div>
       <div>
        <label class="block text-gray-700 font-medium mb-1" for="checkin-photo">
         Upload Event Photo <span class="text-red-600">*</span>
        </label>
        <input accept="image/*" class="w-full" id="checkin-photo" name="photo" required="" type="file"/>
       </div>
       <button class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" type="submit">
        Check In
       </button>
       <p class="mt-2 text-red-600 font-semibold hidden" id="checkin-error">
       </p>
       <p class="mt-2 text-green-600 font-semibold hidden" id="checkin-success">
       </p>
      </form>
     </div>
    </div>
    <!-- Host Dashboard -->
    <section class="hidden max-w-5xl mx-auto bg-white p-6 rounded-md shadow-md space-y-8" id="page-host-dashboard">
     <h2 class="text-2xl font-semibold text-indigo-700">
      Host Dashboard
     </h2>
     <!-- Create New Event -->
     <section>
      <h3 class="text-xl font-semibold mb-3 border-b border-indigo-300 pb-2">
       Create New Event
      </h3>
      <form autocomplete="off" class="space-y-4" id="create-event-form" novalidate="">
       <div>
        <label class="block text-gray-700 font-medium mb-1" for="event-title">
         Event Title
        </label>
        <input class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" id="event-title" name="title" required="" type="text"/>
       </div>
       <div>
        <label class="block text-gray-700 font-medium mb-1" for="event-description">
         Event Description
        </label>
        <textarea class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" id="event-description" name="description" required="" rows="3"></textarea>
       </div>
       <div>
        <label class="block text-gray-700 font-medium mb-1" for="event-code">
         Attendance Code
        </label>
        <input class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" id="event-code" name="code" required="" type="text"/>
       </div>
       <button class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" type="submit">
        Create Event
       </button>
       <p class="mt-2 text-red-600 font-semibold hidden" id="create-event-error">
       </p>
       <p class="mt-2 text-green-600 font-semibold hidden" id="create-event-success">
       </p>
      </form>
     </section>
     <!-- Announcement Management -->
     <section>
      <h3 class="text-xl font-semibold mb-3 border-b border-indigo-300 pb-2">
       Announcement
      </h3>
      <form autocomplete="off" class="space-y-4" id="announcement-form" novalidate="">
       <div>
        <label class="block text-gray-700 font-medium mb-1" for="announcement-text">
         Announcement Text
        </label>
        <textarea class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" id="announcement-text" name="announcement" placeholder="Write announcement to show on homepage" rows="3"></textarea>
       </div>
       <button class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" type="submit">
        Update Announcement
       </button>
       <p class="mt-2 text-green-600 font-semibold hidden" id="announcement-success">
       </p>
      </form>
     </section>
     <!-- Attendance Logs -->
     <section>
      <h3 class="text-xl font-semibold mb-3 border-b border-indigo-300 pb-2">
       Attendance Logs
      </h3>
      <div class="space-y-6 overflow-x-auto" id="attendance-logs">
      </div>
     </section>
     <!-- Events List with Delete -->
     <section>
      <h3 class="text-xl font-semibold mb-3 border-b border-indigo-300 pb-2">
       Your Events
      </h3>
      <div id="host-events-list" class="space-y-6">
      </div>
     </section>
    </section>
   </main>
   <!-- Footer -->
   <footer class="mt-12 py-6 text-center text-gray-500 text-sm select-none">
    © 2024 CPE S.Y.N.C. All rights reserved.
   </footer>
  </div>
  <script>
   (() => {
      // Constants
      const HOST_LOGIN_CODE = "HOST2024SYNC";
      const HOST_REGISTRATION_CODE = "HOST2024SYNC";

      // Elements
      const navHomeBtn = document.getElementById("nav-home");
      const navLoginBtn = document.getElementById("nav-login");
      const navRegisterBtn = document.getElementById("nav-register");
      const navLogoutBtn = document.getElementById("nav-logout");

      const pageHome = document.getElementById("page-home");
      const pageLogin = document.getElementById("page-login");
      const pageRegister = document.getElementById("page-register");
      const pageHostDashboard = document.getElementById("page-host-dashboard");

      const loginForm = document.getElementById("login-form");
      const registerForm = document.getElementById("register-form");
      const createEventForm = document.getElementById("create-event-form");
      const announcementForm = document.getElementById("announcement-form");

      const loginError = document.getElementById("login-error");
      const registerError = document.getElementById("register-error");
      const createEventError = document.getElementById("create-event-error");
      const createEventSuccess = document.getElementById("create-event-success");
      const announcementSuccess = document.getElementById("announcement-success");

      const announcementBanner = document.getElementById("announcement-banner");

      const eventsList = document.getElementById("events-list");
      const attendanceLogsContainer = document.getElementById("attendance-logs");
      const hostEventsList = document.getElementById("host-events-list");

      const goRegisterBtn = document.getElementById("go-register");
      const goLoginBtn = document.getElementById("go-login");

      const checkinModal = document.getElementById("checkin-modal");
      const checkinCloseBtn = document.getElementById("checkin-close");
      const checkinEventTitle = document.getElementById("checkin-event-title");
      const checkinForm = document.getElementById("checkin-form");
      const checkinCodeInput = document.getElementById("checkin-code");
      const checkinPhotoInput = document.getElementById("checkin-photo");
      const checkinError = document.getElementById("checkin-error");
      const checkinSuccess = document.getElementById("checkin-success");

      const announcementTextArea = document.getElementById("announcement-text");

      // State
      let currentUser = null; // {username, isHost}
      let currentCheckinEventId = null;

      // Storage keys
      const STORAGE_USERS = "cpe_sync_users";
      const STORAGE_EVENTS = "cpe_sync_events";
      const STORAGE_ANNOUNCEMENT = "cpe_sync_announcement";
      const STORAGE_ATTENDANCE = "cpe_sync_attendance";
      const STORAGE_SESSION = "cpe_sync_session";

      // Utility Functions
      function saveToStorage(key, value) {
        localStorage.setItem(key, JSON.stringify(value));
      }
      function loadFromStorage(key) {
        const val = localStorage.getItem(key);
        if (!val) return null;
        try {
          return JSON.parse(val);
        } catch {
          return null;
        }
      }

      function generateId() {
        return "id-" + Math.random().toString(36).substr(2, 9);
      }

      function formatDateTime(date) {
        return new Date(date).toLocaleString(undefined, {
          dateStyle: "medium",
          timeStyle: "short",
        });
      }

      // User Management
      function getUsers() {
        return loadFromStorage(STORAGE_USERS) || [];
      }
      function saveUsers(users) {
        saveToStorage(STORAGE_USERS, users);
      }
      function findUser(username) {
        const users = getUsers();
        return users.find((u) => u.username.toLowerCase() === username.toLowerCase());
      }
      function addUser(user) {
        const users = getUsers();
        users.push(user);
        saveUsers(users);
      }

      // Events Management
      function getEvents() {
        return loadFromStorage(STORAGE_EVENTS) || [];
      }
      function saveEvents(events) {
        saveToStorage(STORAGE_EVENTS, events);
      }
      function addEvent(event) {
        const events = getEvents();
        events.push(event);
        saveEvents(events);
      }
      function updateEvent(updatedEvent) {
        const events = getEvents();
        const idx = events.findIndex((e) => e.id === updatedEvent.id);
        if (idx !== -1) {
          events[idx] = updatedEvent;
          saveEvents(events);
        }
      }
      function deleteEvent(eventId) {
        let events = getEvents();
        events = events.filter((e) => e.id !== eventId);
        saveEvents(events);
        // Also remove attendance records for this event
        let attendance = getAttendance();
        attendance = attendance.filter((a) => a.eventId !== eventId);
        saveAttendance(attendance);
      }

      // Attendance Management
      function getAttendance() {
        return loadFromStorage(STORAGE_ATTENDANCE) || [];
      }
      function saveAttendance(attendance) {
        saveToStorage(STORAGE_ATTENDANCE, attendance);
      }
      function addAttendanceRecord(record) {
        const attendance = getAttendance();
        attendance.push(record);
        saveAttendance(attendance);
      }
      function getAttendanceByEvent(eventId) {
        const attendance = getAttendance();
        return attendance.filter((a) => a.eventId === eventId);
      }

      // Session Management
      function saveSession(user) {
        saveToStorage(STORAGE_SESSION, user);
      }
      function loadSession() {
        return loadFromStorage(STORAGE_SESSION);
      }
      function clearSession() {
        localStorage.removeItem(STORAGE_SESSION);
      }

      // Announcement Management
      function getAnnouncement() {
        return loadFromStorage(STORAGE_ANNOUNCEMENT) || "";
      }
      function saveAnnouncement(text) {
        saveToStorage(STORAGE_ANNOUNCEMENT, text);
      }

      // UI Helpers
      function showPage(page) {
        [pageHome, pageLogin, pageRegister, pageHostDashboard].forEach((p) => {
          p.classList.add("hidden");
        });
        page.classList.remove("hidden");
      }

      function updateNav() {
        if (currentUser) {
          navLoginBtn.classList.add("hidden");
          navRegisterBtn.classList.add("hidden");
          navLogoutBtn.classList.remove("hidden");
          navHomeBtn.classList.remove("hidden");
        } else {
          navLoginBtn.classList.remove("hidden");
          navRegisterBtn.classList.remove("hidden");
          navLogoutBtn.classList.add("hidden");
          navHomeBtn.classList.remove("hidden");
        }
      }

      function showAnnouncement() {
        const announcement = getAnnouncement();
        if (announcement && announcement.trim() !== "") {
          announcementBanner.textContent = announcement;
          announcementBanner.classList.remove("hidden");
        } else {
          announcementBanner.classList.add("hidden");
        }
      }

      // Render Events List on Home Page (hide attendance code)
      function renderEventsList() {
        const events = getEvents();

        if (events.length === 0) {
          eventsList.innerHTML = `<p class="text-gray-600 italic">No upcoming or current events available.</p>`;
          return;
        }

        eventsList.innerHTML = "";
        events.forEach((event) => {
          const eventCard = document.createElement("article");
          eventCard.className = "bg-white rounded-md shadow p-5 border border-gray-200";

          const titleEl = document.createElement("h3");
          titleEl.className = "text-lg font-semibold text-indigo-700 mb-2";
          titleEl.textContent = event.title;

          const descEl = document.createElement("p");
          descEl.className = "text-gray-700 mb-3 whitespace-pre-line";
          descEl.textContent = event.description;

          // Attendance code hidden from regular users

          const checkinBtn = document.createElement("button");
          checkinBtn.className = "bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500";
          checkinBtn.textContent = "Check In";
          checkinBtn.addEventListener("click", () => openCheckinModal(event.id));

          eventCard.appendChild(titleEl);
          eventCard.appendChild(descEl);
          eventCard.appendChild(checkinBtn);

          eventsList.appendChild(eventCard);
        });
      }

      // Render Attendance Logs for Host Dashboard
      function renderAttendanceLogs() {
        attendanceLogsContainer.innerHTML = "";
        const events = getEvents();
        if (events.length === 0) {
          attendanceLogsContainer.innerHTML = `<p class="text-gray-600 italic">No events created yet.</p>`;
          return;
        }

        events.forEach((event) => {
          const eventSection = document.createElement("section");
          eventSection.className = "border border-gray-300 rounded-md p-4 bg-gray-50";

          const eventTitle = document.createElement("h4");
          eventTitle.className = "text-lg font-semibold text-indigo-700 mb-3";
          eventTitle.textContent = event.title;

          const attendanceRecords = getAttendanceByEvent(event.id);

          if (attendanceRecords.length === 0) {
            const noRecords = document.createElement("p");
            noRecords.className = "text-gray-600 italic";
            noRecords.textContent = "No attendance records for this event.";
            eventSection.appendChild(eventTitle);
            eventSection.appendChild(noRecords);
          } else {
            const table = document.createElement("table");
            table.className = "w-full border-collapse";

            const thead = document.createElement("thead");
            thead.innerHTML = `
              <tr class="bg-indigo-100 text-indigo-700">
                <th class="border border-indigo-300 px-3 py-1 text-left">Username</th>
                <th class="border border-indigo-300 px-3 py-1 text-left">Check-in Time</th>
                <th class="border border-indigo-300 px-3 py-1 text-left">Photo</th>
              </tr>
            `;
            table.appendChild(thead);

            const tbody = document.createElement("tbody");

            attendanceRecords.forEach((record) => {
              const tr = document.createElement("tr");
              tr.className = "even:bg-white odd:bg-gray-100";

              const usernameTd = document.createElement("td");
              usernameTd.className = "border border-indigo-300 px-3 py-1";
              usernameTd.textContent = record.username;

              const timeTd = document.createElement("td");
              timeTd.className = "border border-indigo-300 px-3 py-1";
              timeTd.textContent = formatDateTime(record.timestamp);

              const photoTd = document.createElement("td");
              photoTd.className = "border border-indigo-300 px-3 py-1";

              if (record.photoDataUrl) {
                const img = document.createElement("img");
                img.src = record.photoDataUrl;
                img.alt = `Uploaded photo by ${record.username} for event ${event.title}`;
                img.className = "h-16 w-16 object-cover rounded-md border border-gray-300";
                photoTd.appendChild(img);
              } else {
                photoTd.textContent = "No photo";
                photoTd.classList.add("italic", "text-gray-500");
              }

              tr.appendChild(usernameTd);
              tr.appendChild(timeTd);
              tr.appendChild(photoTd);

              tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            eventSection.appendChild(eventTitle);
            eventSection.appendChild(table);
          }

          attendanceLogsContainer.appendChild(eventSection);
        });
      }

      // Render Host Events List with delete and show event code
      function renderHostEventsList() {
        const events = getEvents();

        if (events.length === 0) {
          hostEventsList.innerHTML = `<p class="text-gray-600 italic">No events created yet.</p>`;
          return;
        }

        hostEventsList.innerHTML = "";
        events.forEach((event) => {
          const eventCard = document.createElement("article");
          eventCard.className = "bg-white rounded-md shadow p-5 border border-gray-200 flex flex-col sm:flex-row sm:items-center sm:justify-between";

          const leftDiv = document.createElement("div");
          leftDiv.className = "mb-3 sm:mb-0";

          const titleEl = document.createElement("h4");
          titleEl.className = "text-lg font-semibold text-indigo-700 mb-1";
          titleEl.textContent = event.title;

          const descEl = document.createElement("p");
          descEl.className = "text-gray-700 mb-1 whitespace-pre-line";
          descEl.textContent = event.description;

          const codeEl = document.createElement("p");
          codeEl.className = "text-sm text-gray-600 font-mono select-all";
          codeEl.innerHTML = `<strong>Attendance Code:</strong> ${event.code}`;

          leftDiv.appendChild(titleEl);
          leftDiv.appendChild(descEl);
          leftDiv.appendChild(codeEl);

          const rightDiv = document.createElement("div");
          rightDiv.className = "flex space-x-2";

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 flex items-center";
          deleteBtn.innerHTML = `<i class="fas fa-trash-alt mr-2"></i>Delete`;
          deleteBtn.addEventListener("click", () => {
            if (confirm(`Are you sure you want to delete the event "${event.title}"? This action cannot be undone.`)) {
              deleteEvent(event.id);
              renderHostEventsList();
              renderAttendanceLogs();
              renderEventsList();
            }
          });

          rightDiv.appendChild(deleteBtn);

          eventCard.appendChild(leftDiv);
          eventCard.appendChild(rightDiv);

          hostEventsList.appendChild(eventCard);
        });
      }

      // Open Check-in Modal
      function openCheckinModal(eventId) {
        if (!currentUser) {
          alert("You must be logged in to check in.");
          showPage(pageLogin);
          return;
        }
        const events = getEvents();
        const event = events.find((e) => e.id === eventId);
        if (!event) return;

        currentCheckinEventId = eventId;
        checkinEventTitle.textContent = event.title;
        checkinCodeInput.value = "";
        checkinPhotoInput.value = "";
        checkinError.classList.add("hidden");
        checkinSuccess.classList.add("hidden");
        checkinModal.classList.remove("hidden");
        checkinCodeInput.focus();
      }

      // Close Check-in Modal
      function closeCheckinModal() {
        currentCheckinEventId = null;
        checkinModal.classList.add("hidden");
      }

      // Login Handler
      loginForm.addEventListener("submit", (e) => {
        e.preventDefault();
        loginError.classList.add("hidden");
        const username = loginForm.username.value.trim();
        const password = loginForm.password.value;
        const hostcode = loginForm.hostcode.value.trim();

        if (!username || !password) {
          loginError.textContent = "Please fill in all required fields.";
          loginError.classList.remove("hidden");
          return;
        }

        const user = findUser(username);
        if (!user) {
          loginError.textContent = "User not found.";
          loginError.classList.remove("hidden");
          return;
        }
        if (user.password !== password) {
          loginError.textContent = "Incorrect password.";
          loginError.classList.remove("hidden");
          return;
        }

        // If hostcode provided, verify it matches HOST_LOGIN_CODE
        if (hostcode) {
          if (hostcode !== HOST_LOGIN_CODE) {
            loginError.textContent = "Invalid host login code.";
            loginError.classList.remove("hidden");
            return;
          }
          if (!user.isHost) {
            loginError.textContent = "This user is not registered as a host.";
            loginError.classList.remove("hidden");
            return;
          }
        } else {
          // If user is host but no hostcode provided, deny login as host
          if (user.isHost) {
            loginError.textContent = "Host login code required for host accounts.";
            loginError.classList.remove("hidden");
            return;
          }
        }

        currentUser = { username: user.username, isHost: user.isHost };
        saveSession(currentUser);
        loginForm.reset();
        loginError.classList.add("hidden");
        updateNav();
        showAnnouncement();
        if (currentUser.isHost) {
          announcementTextArea.value = getAnnouncement();
          renderAttendanceLogs();
          renderHostEventsList();
          showPage(pageHostDashboard);
        } else {
          renderEventsList();
          showPage(pageHome);
        }
      });

      // Register Handler
      registerForm.addEventListener("submit", (e) => {
        e.preventDefault();
        registerError.classList.add("hidden");
        const username = registerForm.username.value.trim();
        const password = registerForm.password.value;
        const hostcode = registerForm.hostcode.value.trim();

        if (!username || !password) {
          registerError.textContent = "Please fill in all required fields.";
          registerError.classList.remove("hidden");
          return;
        }

        if (findUser(username)) {
          registerError.textContent = "Username already exists.";
          registerError.classList.remove("hidden");
          return;
        }

        let isHost = false;
        if (hostcode) {
          if (hostcode !== HOST_REGISTRATION_CODE) {
            registerError.textContent = "Invalid host registration code.";
            registerError.classList.remove("hidden");
            return;
          }
          isHost = true;
        }

        addUser({ username, password, isHost });
        registerForm.reset();
        registerError.classList.add("hidden");
        alert("Registration successful! You can now log in.");
        showPage(pageLogin);
      });

      // Logout Handler
      navLogoutBtn.addEventListener("click", () => {
        currentUser = null;
        clearSession();
        updateNav();
        showAnnouncement();
        renderEventsList();
        showPage(pageHome);
      });

      // Navigation Buttons
      navHomeBtn.addEventListener("click", () => {
        if (currentUser && currentUser.isHost) {
          announcementTextArea.value = getAnnouncement();
          renderAttendanceLogs();
          renderHostEventsList();
          showPage(pageHostDashboard);
        } else {
          renderEventsList();
          showPage(pageHome);
        }
      });
      navLoginBtn.addEventListener("click", () => {
        showPage(pageLogin);
      });
      navRegisterBtn.addEventListener("click", () => {
        showPage(pageRegister);
      });
      goRegisterBtn.addEventListener("click", () => {
        showPage(pageRegister);
      });
      goLoginBtn.addEventListener("click", () => {
        showPage(pageLogin);
      });

      // Create Event Handler (Host)
      createEventForm.addEventListener("submit", (e) => {
        e.preventDefault();
        createEventError.classList.add("hidden");
        createEventSuccess.classList.add("hidden");

        const title = createEventForm.title.value.trim();
        const description = createEventForm.description.value.trim();
        const code = createEventForm.code.value.trim();

        if (!title || !description || !code) {
          createEventError.textContent = "Please fill in all required fields.";
          createEventError.classList.remove("hidden");
          return;
        }

        // Check if attendance code is unique among events
        const events = getEvents();
        if (events.some((ev) => ev.code === code)) {
          createEventError.textContent = "Attendance code must be unique.";
          createEventError.classList.remove("hidden");
          return;
        }

        const newEvent = {
          id: generateId(),
          title,
          description,
          code,
        };
        addEvent(newEvent);
        createEventForm.reset();
        createEventSuccess.textContent = "Event created successfully.";
        createEventSuccess.classList.remove("hidden");
        renderAttendanceLogs();
        renderHostEventsList();
      });

      // Announcement Update Handler (Host)
      announcementForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const text = announcementTextArea.value.trim();
        saveAnnouncement(text);
        announcementSuccess.textContent = "Announcement updated.";
        announcementSuccess.classList.remove("hidden");
        showAnnouncement();
        setTimeout(() => {
          announcementSuccess.classList.add("hidden");
        }, 3000);
      });

      // Check-in Form Handler
      checkinForm.addEventListener("submit", (e) => {
        e.preventDefault();
        checkinError.classList.add("hidden");
        checkinSuccess.classList.add("hidden");

        const codeEntered = checkinCodeInput.value.trim();
        if (!codeEntered) {
          checkinError.textContent = "Please enter the attendance code.";
          checkinError.classList.remove("hidden");
          return;
        }

        const file = checkinPhotoInput.files[0];
        if (!file) {
          checkinError.textContent = "Photo upload is required for check-in.";
          checkinError.classList.remove("hidden");
          return;
        }

        const events = getEvents();
        const event = events.find((e) => e.id === currentCheckinEventId);
        if (!event) {
          checkinError.textContent = "Event not found.";
          checkinError.classList.remove("hidden");
          return;
        }

        if (codeEntered !== event.code) {
          checkinError.textContent = "Incorrect attendance code.";
          checkinError.classList.remove("hidden");
          return;
        }

        // Check if user already checked in for this event
        const attendance = getAttendance();
        if (attendance.some((a) => a.eventId === event.id && a.username === currentUser.username)) {
          checkinError.textContent = "You have already checked in for this event.";
          checkinError.classList.remove("hidden");
          return;
        }

        // Handle photo upload (simulate storing as base64 data URL)
        const reader = new FileReader();
        reader.onload = function (ev) {
          const photoDataUrl = ev.target.result;
          addAttendanceRecord({
            eventId: event.id,
            username: currentUser.username,
            timestamp: Date.now(),
            photoDataUrl,
          });
          checkinSuccess.textContent = "Check-in successful!";
          checkinSuccess.classList.remove("hidden");
          checkinError.classList.add("hidden");
          checkinForm.reset();
          setTimeout(() => {
            closeCheckinModal();
          }, 1500);
        };
        reader.readAsDataURL(file);
      });

      // Close checkin modal button
      checkinCloseBtn.addEventListener("click", () => {
        closeCheckinModal();
      });

      // Close modal on outside click
      checkinModal.addEventListener("click", (e) => {
        if (e.target === checkinModal) {
          closeCheckinModal();
        }
      });

      // Initialization
      function init() {
        // Load session
        const sessionUser = loadSession();
        if (sessionUser) {
          currentUser = sessionUser;
        }

        updateNav();
        showAnnouncement();

        if (currentUser) {
          if (currentUser.isHost) {
            announcementTextArea.value = getAnnouncement();
            renderAttendanceLogs();
            renderHostEventsList();
            showPage(pageHostDashboard);
          } else {
            renderEventsList();
            showPage(pageHome);
          }
        } else {
          renderEventsList();
          showPage(pageHome);
        }
      }

      init();
    })();
  </script>
 </body>
</html>